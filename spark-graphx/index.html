<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Gatech CSE big data bootcamp">
    <title>Spark GraphX - Bigdata Bootcamp</title>

    <link rel="canonical" href="http://bigdata.manul.io/spark-graphx/">
    <!-- favicon -->
    <link rel="icon" type="image/png" sizes="100x60" href="/image/favicon.png">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/bigdata-bootcamp.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- TOC -->
    <link rel="stylesheet" href="/css/jquery.tocify.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Bigdata Bootcamp</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
<!--                 <li>
                    <a href="/">Home</a>
                </li> -->
                <li>
                    <a href="/contact/">Contact us</a>
                </li>
<!--                 <li>
                    <a href="/spark/">Spark</a>
                </li> -->
<!--                 <li>
                    <a href="/hadoop/">Hadoop</a>
                </li> -->
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li>
                    <a href="/">Home</a>
                </li>
<!--                 <li>
                    <a href="/about/">About</a>
                </li> -->
                <li>
                    <a href="/hadoop/">Hadoop</a>
                </li>
                <li>
                    <a href="/spark/">Spark</a>
                </li>
                <li><a href="/environment/">Environment</a></li>
                <li><a href="/data/">Data</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Page Header -->
<header class="intro-header" style="background-image: url('/image/background.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="site-heading" style="padding: 100px 0px 50px 0px">
                    <h1>Spark GraphX</h1>
                    <hr class="small">
                    <span class="subheading">Georgia Tech big data bootcamp training material</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="container">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <p>In this section, we show how to create a graph with patient and diagnostic code. Then, we show how to run algorithms on the the newly created graph.</p>

<h1 id="basic-concept">Basic concept</h1>

<p>Spark GraphX abstracts the graph as a concept named property graph, which means that each edge and vertex is associated with some property. The <code class="prettyprint">Graph</code> class has below definition</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">Graph</span><span class="o">[</span><span class="kt">VD</span>, <span class="kt">ED</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">vertices</span><span class="k">:</span> <span class="kt">VertexRDD</span><span class="o">[</span><span class="kt">VD</span><span class="o">]</span>
  <span class="k">val</span> <span class="n">edges</span><span class="k">:</span> <span class="kt">EdgeRDD</span><span class="o">[</span><span class="kt">ED</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div>
<p>We could regard <code class="prettyprint">VertexRDD[VD]</code> as RDD of <code class="prettyprint">(VertexID, VD)</code> tuple and <code class="prettyprint">EdgeRDD[ED]</code> as RDD of <code class="prettyprint">(VertexID, VertexID, ED)</code>.</p>

<h1 id="graph-construction">Graph construction</h1>

<p>Let&#39;s create a graph of patients and diagnostic codes. For each patient we could assign its patient id as vertex property, and for each diagnostic code, we will the code as vertex property. For the edge between patient and diagnostic code, we will use number of times the patient is diagnosed with given disease.</p>

<ol>
<li><p>define  necessary data structure and import</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.spark.SparkContext._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.graphx._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.rdd.RDD</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">VertexProperty</span> <span class="k">extends</span> <span class="nc">Serializable</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">PatientProperty</span><span class="o">(</span><span class="n">patientId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">VertexProperty</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">DiagnosticProperty</span><span class="o">(</span><span class="n">icd9code</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">VertexProperty</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">PatientEvent</span><span class="o">(</span><span class="n">patientId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">eventName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">date</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span>
</code></pre></div></li>
<li><p>load patient event data and filter out diagnostic related only</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">allEvents</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="s">"data/"</span><span class="o">).</span>
    <span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">","</span><span class="o">)).</span>
    <span class="n">map</span><span class="o">(</span><span class="n">splits</span> <span class="k">=&gt;</span> <span class="nc">PatientEvent</span><span class="o">(</span><span class="n">splits</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">splits</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">splits</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="n">toInt</span><span class="o">,</span> <span class="n">splits</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="n">toDouble</span><span class="o">))</span>

<span class="c1">// get and cache dianosticEvents as we will reuse
</span><span class="k">val</span> <span class="n">diagnosticEvents</span> <span class="k">=</span> <span class="n">allEvents</span><span class="o">.</span>
    <span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">eventName</span><span class="o">.</span><span class="n">startsWith</span><span class="o">(</span><span class="s">"DIAG"</span><span class="o">)).</span><span class="n">cache</span><span class="o">()</span>
</code></pre></div></li>
<li><p>create patient vertex</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="c1">// create patient vertex
</span><span class="k">val</span> <span class="n">patientVertexIdRDD</span> <span class="k">=</span> <span class="n">diagnosticEvents</span><span class="o">.</span>
    <span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">patientId</span><span class="o">).</span>  
    <span class="n">distinct</span><span class="o">.</span>            <span class="c1">// get distinct patient ids
</span>    <span class="n">zipWithIndex</span>         <span class="c1">// assign an index as vertex id
</span>
<span class="k">val</span> <span class="n">patient2VertexId</span> <span class="k">=</span> <span class="n">patientVertexIdRDD</span><span class="o">.</span><span class="n">collect</span><span class="o">.</span><span class="n">toMap</span>
<span class="k">val</span> <span class="n">patientVertex</span> <span class="k">=</span> <span class="n">patientVertexIdRDD</span><span class="o">.</span>
    <span class="n">map</span><span class="o">{</span><span class="k">case</span><span class="o">(</span><span class="n">patientId</span><span class="o">,</span> <span class="n">index</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="nc">PatientProperty</span><span class="o">(</span><span class="n">patientId</span><span class="o">))}.</span>
    <span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">RDD</span><span class="o">[(</span><span class="kt">VertexId</span>, <span class="kt">VertexProperty</span><span class="o">)]]</span>
</code></pre></div>
<p>Notice that in order to assign an unique ID for each vertex, we finally <code class="prettyprint">collect</code> all the patient to <code class="prettyprint">VertrexID</code> mapping. Theoritically this is not an efficient practice. One could mitigate uniqueness of ID by calculating ID directly with Hash.</p></li>
<li><p>create diagnostic code vertex</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="c1">// create diagnostic code vertex
</span><span class="k">val</span> <span class="n">startIndex</span> <span class="k">=</span> <span class="n">patient2VertexId</span><span class="o">.</span><span class="n">size</span>
<span class="k">val</span> <span class="n">diagnosticVertexIdRDD</span> <span class="k">=</span> <span class="n">diagnosticEvents</span><span class="o">.</span>
    <span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">eventName</span><span class="o">).</span>
    <span class="n">distinct</span><span class="o">.</span>
    <span class="n">zipWithIndex</span><span class="o">.</span>
    <span class="n">map</span><span class="o">{</span><span class="k">case</span><span class="o">(</span><span class="n">icd9code</span><span class="o">,</span> <span class="n">zeroBasedIndex</span><span class="o">)</span> <span class="k">=&gt;</span> 
        <span class="o">(</span><span class="n">icd9code</span><span class="o">,</span> <span class="n">zeroBasedIndex</span> <span class="o">+</span> <span class="n">startIndex</span><span class="o">)}</span> <span class="c1">// make sure no confilic with patient vertex id
</span>
<span class="k">val</span> <span class="n">diagnostic2VertexId</span> <span class="k">=</span> <span class="n">diagnosticVertexIdRDD</span><span class="o">.</span><span class="n">collect</span><span class="o">.</span><span class="n">toMap</span>

<span class="k">val</span> <span class="n">diagnosticVertex</span> <span class="k">=</span> <span class="n">diagnosticVertexIdRDD</span><span class="o">.</span>
    <span class="n">map</span><span class="o">{</span><span class="k">case</span><span class="o">(</span><span class="n">icd9code</span><span class="o">,</span> <span class="n">index</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="nc">DiagnosticProperty</span><span class="o">(</span><span class="n">icd9code</span><span class="o">))}.</span>
    <span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">RDD</span><span class="o">[(</span><span class="kt">VertexId</span>, <span class="kt">VertexProperty</span><span class="o">)]]</span>
</code></pre></div>
<p>Here we assign vertex id by adding the result of <code class="prettyprint">zipWithIndex</code> with an offset obtained from previous patient vertex to avoid ID confilication between patient and diagnostic code.</p></li>
<li><p>create edges </p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">bcPatient2VertexId</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">broadcast</span><span class="o">(</span><span class="n">patient2VertexId</span><span class="o">)</span>
<span class="k">val</span> <span class="n">bcDiagnostic2VertexId</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">broadcast</span><span class="o">(</span><span class="n">diagnostic2VertexId</span><span class="o">)</span>

<span class="k">val</span> <span class="n">edges</span> <span class="k">=</span> <span class="n">diagnosticEvents</span><span class="o">.</span>
    <span class="n">map</span><span class="o">(</span><span class="n">event</span> <span class="k">=&gt;</span> <span class="o">((</span><span class="n">event</span><span class="o">.</span><span class="n">patientId</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="n">eventName</span><span class="o">),</span> <span class="mi">1</span><span class="o">)).</span>
    <span class="n">reduceByKey</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">).</span>
    <span class="n">map</span><span class="o">{</span><span class="k">case</span><span class="o">((</span><span class="n">patientId</span><span class="o">,</span> <span class="n">icd9code</span><span class="o">),</span> <span class="n">count</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">patientId</span><span class="o">,</span> <span class="n">icd9code</span><span class="o">,</span> <span class="n">count</span><span class="o">)}.</span>
    <span class="n">map</span><span class="o">{</span><span class="k">case</span><span class="o">(</span><span class="n">patientId</span><span class="o">,</span> <span class="n">icd9code</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Edge</span><span class="o">(</span>
        <span class="n">bcPatient2VertexId</span><span class="o">.</span><span class="n">value</span><span class="o">(</span><span class="n">patientId</span><span class="o">),</span>
        <span class="n">bcDiagnostic2VertexId</span><span class="o">.</span><span class="n">value</span><span class="o">(</span><span class="n">icd9code</span><span class="o">),</span>
        <span class="n">count</span>
    <span class="o">)}</span>
</code></pre></div>
<p>We first broadcast patient and diagnostic code to vertext id mappting. Broadcast could avoid uncessary copy in distributed setting thus will be more effecient. Then we count occurrence of <code class="prettyprint">(patient-id, icd-9-code)</code> pairs with <code class="prettyprint">map</code> and <code class="prettyprint">reduceByKey</code>, finally we translate them to proper <code class="prettyprint">VertexID</code>.</p></li>
<li><p>put it together to create the graph</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">vertices</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">union</span><span class="o">(</span><span class="n">patientVertex</span><span class="o">,</span> <span class="n">diagnosticVertex</span><span class="o">)</span>
<span class="k">val</span> <span class="n">graph</span> <span class="k">=</span> <span class="nc">Graph</span><span class="o">(</span><span class="n">vertices</span><span class="o">,</span> <span class="n">edges</span><span class="o">)</span>
</code></pre></div></li>
</ol>

<h1 id="graph-operation">Graph operation</h1>

<p>Given the graph we created, we could run some basic graph operations.</p>

<h2 id="connected-components">Connected components</h2>

<p><a href="http://en.wikipedia.org/wiki/Connected_component_(">Connected component</a> could help find disconnected subgraphs. GraphX provide the API to get connected components as below</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">connectedComponents</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">connectedComponents</span>
</code></pre></div>
<p>The return result is a graph and assigned components of original graph is stored as <code class="prettyprint">VertexProperty</code>. For example</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">scala</span><span class="o">&gt;</span> <span class="n">connectedComponents</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
<span class="nc">Array</span><span class="o">[(</span><span class="kt">org.apache.spark.graphx.VertexId</span>, <span class="kt">org.apache.spark.graphx.VertexId</span><span class="o">)]</span> <span class="k">=</span> 
<span class="nc">Array</span><span class="o">((</span><span class="mi">2556</span><span class="o">,</span><span class="mi">0</span><span class="o">),</span> <span class="o">(</span><span class="mi">1260</span><span class="o">,</span><span class="mi">0</span><span class="o">),</span> <span class="o">(</span><span class="mi">1410</span><span class="o">,</span><span class="mi">0</span><span class="o">),</span> <span class="o">(</span><span class="mi">324</span><span class="o">,</span><span class="mi">0</span><span class="o">),</span> <span class="o">(</span><span class="mi">180</span><span class="o">,</span><span class="mi">0</span><span class="o">))</span>
</code></pre></div>
<p>The first element of the tuple is <code class="prettyprint">VertexID</code> identical to original graph. The second element in the tuple is <code class="prettyprint">connected component</code> represented by smalled <code class="prettyprint">VertexID</code> in that component. In above example, five vertices belong to same component.</p>

<p>We could easily get number of connected components using operations on RDD as below.</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">scala</span><span class="o">&gt;</span> <span class="n">connectedComponents</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span><span class="o">).</span><span class="n">distinct</span><span class="o">.</span><span class="n">collect</span>
<span class="nc">Array</span><span class="o">[</span><span class="kt">org.apache.spark.graphx.VertexId</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">169</span><span class="o">,</span> <span class="mi">239</span><span class="o">)</span>
</code></pre></div>
<h2 id="degree">Degree</h2>

<p>The property graph abstraction of GraphX is directed graph. It provides computation of in-dgree, out-degree and total degree. For example, we could get degrees as</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">inDegrees</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">inDegrees</span>
<span class="k">val</span> <span class="n">outDegrees</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">outDegrees</span>
<span class="k">val</span> <span class="n">totalDegrees</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">degrees</span>
</code></pre></div>
<h2 id="pagerank">PageRank</h2>

<p>GraphX also provides implementation of the famous <a href="http://en.wikipedia.org/wiki/PageRank">PageRank</a> algorithm, which could compute the &#39;importance&#39; of a vertex. The graph we generated above is a bipartite graph and not suitable for PageRank. To gve an example of PageRank, we randomly generate a graph and run fixed iteration of PageRank algorithm on it.</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.spark.graphx.util.GraphGenerators</span>

<span class="k">val</span> <span class="n">randomGraph</span> <span class="k">=</span> <span class="nc">Graph</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> 
   <span class="nc">GraphGenerators</span><span class="o">.</span><span class="n">logNormalGraph</span><span class="o">(</span><span class="n">sc</span><span class="o">,</span> <span class="n">numVertices</span> <span class="k">=</span> <span class="mi">100</span><span class="o">)</span>

<span class="k">val</span> <span class="n">pagerank</span> <span class="k">=</span> <span class="n">randomGraph</span><span class="o">.</span><span class="n">staticPageRank</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
</code></pre></div>
<p>Or, we could run PageRank util converge with tolerance as <code class="prettyprint">0.01</code> using <code class="prettyprint">randomGraph.pageRank(0.01)</code></p>

<h1 id="application">Application</h1>

<p>Next, we show some how we could ultilize the graph operations to solve some practical problems in the healthcare domain.</p>

<h2 id="explore-comorbidities">Explore comorbidities</h2>

<p><a href="http://en.wikipedia.org/wiki/Comorbidity">Comorbidity</a> is additional disorders co-occuring with primary disease. We know all the case patients have heart failure, we could explore possible comorbidities as below (see comments for more explaination)</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="c1">// get all the case patients
</span><span class="k">val</span> <span class="n">casePatients</span> <span class="k">=</span> <span class="n">allEvents</span><span class="o">.</span>
    <span class="n">filter</span><span class="o">(</span><span class="n">event</span> <span class="k">=&gt;</span> <span class="n">event</span><span class="o">.</span><span class="n">eventName</span> <span class="o">==</span> <span class="s">"heartfailure"</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mf">1.0</span><span class="o">).</span>
    <span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">patientId</span><span class="o">).</span>
    <span class="n">collect</span><span class="o">.</span>
    <span class="n">toSet</span>

<span class="c1">// broadcast
</span><span class="k">val</span> <span class="n">scCasePatients</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">broadcast</span><span class="o">(</span><span class="n">casePatients</span><span class="o">)</span>

<span class="c1">//filter the graph with subGraph operation
</span><span class="k">val</span> <span class="n">filteredGraph</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">subgraph</span><span class="o">(</span><span class="n">vpred</span> <span class="k">=</span> <span class="o">{</span><span class="k">case</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">attr</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="n">isPatient</span> <span class="k">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">isInstanceOf</span><span class="o">[</span><span class="kt">PatientProperty</span><span class="o">]</span>
        <span class="k">val</span> <span class="n">patient</span> <span class="k">=</span> <span class="k">if</span><span class="o">(</span><span class="n">isPatient</span><span class="o">)</span> <span class="n">attr</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">PatientProperty</span><span class="o">]</span> <span class="k">else</span> <span class="kc">null</span>
        <span class="c1">// return true iff. isn't patient or is case patient
</span>        <span class="o">!</span><span class="n">isPatient</span> <span class="o">||</span> <span class="o">(</span><span class="n">scCasePatients</span><span class="o">.</span><span class="n">value</span> <span class="n">contains</span> <span class="n">patient</span><span class="o">.</span><span class="n">patientId</span><span class="o">)</span>
    <span class="o">})</span>

<span class="c1">//calculate indegrees and get top vertices
</span><span class="k">val</span> <span class="n">top5ComorbidityVertices</span> <span class="k">=</span> <span class="n">filteredGraph</span><span class="o">.</span><span class="n">inDegrees</span><span class="o">.</span>
        <span class="n">takeOrdered</span><span class="o">(</span><span class="mi">5</span><span class="o">)(</span><span class="n">scala</span><span class="o">.</span><span class="nc">Ordering</span><span class="o">.</span><span class="n">by</span><span class="o">(-</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span><span class="o">))</span>
</code></pre></div>
<p>We have</p>
<div class="highlight"><pre><code class="language-" data-lang="">top5ComorbidityVertices: Array[(org.apache.spark.graphx.VertexId, Int)] = Array((3129,86), (335,63), (857,58), (2048,49), (669,48))
</code></pre></div>
<p>And we could check the vertex of index 3129 in original graph is</p>
<div class="highlight"><pre><code class="language-" data-lang="">scala&gt; graph.vertices.filter(_._1 == 3129).collect
Array[(org.apache.spark.graphx.VertexId, VertexProperty)] = 
Array((3129,DiagnosticProperty(DIAG4019)))
</code></pre></div>
<p>The 4019 code correponds to <a href="http://www.hipaaspace.com/Medical_Billing/Coding/ICD-9/Diagnosis/4019">Hypertension</a>, which is reasonable.</p>

<h2 id="similar-patients">Similar patients</h2>

<p>Given a patient diagnostic graph, we could also find similar patients. One of the most straightforward approach is shortest path on the graph.</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">sssp</span> <span class="k">=</span> <span class="n">graph</span><span class="o">.</span>
    <span class="n">mapVertices</span><span class="o">((</span><span class="n">id</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0L</span><span class="o">)</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="nc">Double</span><span class="o">.</span><span class="nc">PositiveInfinity</span><span class="o">).</span>
    <span class="n">pregel</span><span class="o">(</span><span class="nc">Double</span><span class="o">.</span><span class="nc">PositiveInfinity</span><span class="o">)(</span>
        <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">dist</span><span class="o">,</span> <span class="n">newDist</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">min</span><span class="o">(</span><span class="n">dist</span><span class="o">,</span> <span class="n">newDist</span><span class="o">),</span> <span class="c1">// Vertex Program
</span>        <span class="n">triplet</span> <span class="k">=&gt;</span> <span class="o">{</span>  <span class="c1">// Send Message
</span>            <span class="k">var</span> <span class="n">msg</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[(</span><span class="kt">org.apache.spark.graphx.VertexId</span>, <span class="kt">Double</span><span class="o">)]</span> <span class="k">=</span> <span class="nc">Iterator</span><span class="o">.</span><span class="n">empty</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">triplet</span><span class="o">.</span><span class="n">srcAttr</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">triplet</span><span class="o">.</span><span class="n">dstAttr</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">msg</span> <span class="k">=</span> <span class="n">msg</span> <span class="o">++</span> <span class="nc">Iterator</span><span class="o">((</span><span class="n">triplet</span><span class="o">.</span><span class="n">dstId</span><span class="o">,</span> <span class="n">triplet</span><span class="o">.</span><span class="n">srcAttr</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">triplet</span><span class="o">.</span><span class="n">dstAttr</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">triplet</span><span class="o">.</span><span class="n">srcAttr</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">msg</span> <span class="k">=</span> <span class="n">msg</span> <span class="o">++</span> <span class="nc">Iterator</span><span class="o">((</span><span class="n">triplet</span><span class="o">.</span><span class="n">srcId</span><span class="o">,</span> <span class="n">triplet</span><span class="o">.</span><span class="n">dstAttr</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
            <span class="o">}</span>
            <span class="n">println</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
            <span class="n">msg</span>
        <span class="o">},</span>
        <span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">min</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="c1">// Merge Message
</span>    <span class="o">)</span>

<span class="c1">// get top 5 most similar
</span><span class="n">sssp</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span> <span class="o">&lt;</span> <span class="nc">Double</span><span class="o">.</span><span class="nc">PositiveInfinity</span><span class="o">).</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="o">).</span><span class="n">takeOrdered</span><span class="o">(</span><span class="mi">5</span><span class="o">)(</span><span class="n">scala</span><span class="o">.</span><span class="nc">Ordering</span><span class="o">.</span><span class="n">by</span><span class="o">(-</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span><span class="o">))</span>
</code></pre></div>

            <ul class="pager">
                
  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
    
  
  

  
  



<li class="previous">
    <a href="/spark-sql/" data-toggle="tooltip" data-placement="top" title="Previous Lesson">&larr; Spark Sql</a>
</li>

                
  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
      
    
  

  
    
    
  



<li class="next">
    <a href="/spark-mllib/" data-toggle="tooltip" data-placement="top" title="Next Lesson">Spark MLlib&rarr;</a>
</li>


            </ul>

            <div class="clearfix"></div>

            <hr>
            <!-- disqus -->
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES * * */
                var disqus_shortname = 'sunlabbigdata';
                
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        </div>
        <div class="col-lg-2 col-md-1">
            <div id="toc"></div>
        </div>
    </div>
</div>

<hr>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/jimeng" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/cmanul" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/cmanul" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Georgia Institute of Technology 2015. Theme by <a href="https://github.com/IronSummitMedia/startbootstrap-clean-blog-jekyll" target="_blank">Iron Summit Media</a>'s Jekyll version of <a href="http://startbootstrap.com/template-overviews/clean-blog/" target="_blank">Clean Blog</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- TOC -->
<script src="/js/jquery-ui.min.js"></script>
<script src="/js/jquery.tocify.js"></script>

<!-- ACE Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ace.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/bigdata-bootcamp.js "></script>


</body>

</html>
